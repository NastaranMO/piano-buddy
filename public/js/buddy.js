const CONSTANTS={COLORS:["#EE2B29","#ff9800","#ffff00","#c6ff00","#00e5ff","#2979ff","#651fff","#d500f9","#4CAF50"],NUM_BUTTONS:8,NOTES_PER_OCTAVE:12,WHITE_NOTES_PER_OCTAVE:7,LOWEST_PIANO_KEY_MIDI_NOTE:21,GENIE_CHECKPOINT:"https://storage.googleapis.com/magentadata/js/checkpoints/piano_genie/model/epiano/stp_iq_auto_contour_dt_166006"};class Player{constructor(){this.player=new mm.SoundFontPlayer("https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus");this.midiOut=[];this.midiIn=[];this.usingMidiOut=false;this.usingMidiIn=false;this.selectOutElement=document.getElementById("selectOut");this.selectInElement=document.getElementById("selectIn");this.loadAllSamples()}loadAllSamples(){const t={notes:[]};for(let e=0;e<CONSTANTS.NOTES_PER_OCTAVE*OCTAVES;e++){t.notes.push({pitch:CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE+e})}this.player.loadSamples(t)}playNoteDown(e,t){if(this.usingMidiOut){this.sendMidiNoteOn(e,t)}else{mm.Player.tone.context.resume();this.player.playNoteDown({pitch:e})}}playNoteUp(e,t){if(this.usingMidiOut){this.sendMidiNoteOff(e,t)}else{this.player.playNoteUp({pitch:e})}}midiReady(e){e.addEventListener("statechange",e=>this.initDevices(e.target));this.initDevices(e)}initDevices(e){this.midiOut=[];this.midiIn=[];const t=e.outputs.values();for(let e=t.next();e&&!e.done;e=t.next()){this.midiOut.push(e.value)}const n=e.inputs.values();for(let e=n.next();e&&!e.done;e=n.next()){this.midiIn.push(e.value);e.value.onmidimessage=e=>this.getMIDIMessage(e)}this.selectInElement.innerHTML=this.midiIn.map(e=>`<option>${e.name}</option>`).join("");this.selectOutElement.innerHTML=this.midiOut.map(e=>`<option>${e.name}</option>`).join("")}sendMidiNoteOn(e,t){if(t===-1)t=0;const n=[144,e,127];this.midiOut[this.selectOutElement.selectedIndex].send(n)}sendMidiNoteOff(e,t){if(t===-1)t=0;const n=[128,e,127];this.midiOut[this.selectOutElement.selectedIndex].send(n)}getMIDIMessage(e){if(!this.usingMidiIn){return}const t=e.data[0];const n=e.data[1];const i=e.data.length>2?e.data[2]:0;switch(t){case 144:window.buttonDown(n,false);break;case 128:window.buttonUp(n);break}}async start(e){return this.player.start(e.getSequence())}isPlaying=()=>{return this.player.isPlaying()};stop=()=>{if(this.isPlaying()){this.player.stop()}}}class FloatyNotes{constructor(){this.notes=[];this.canvas=document.getElementById("canvas");this.context=this.canvas.getContext("2d");this.context.lineWidth=4;this.context.lineCap="round";this.contextHeight=0}resize(e){this.canvas.width=window.innerWidth;this.canvas.height=this.contextHeight=window.innerHeight-e-20}addNote(e,t,n){const i={x:parseFloat(t),y:0,width:parseFloat(n),height:0,color:CONSTANTS.COLORS[e],on:true};this.notes.push(i);return i}stopNote(e){e.on=false}drawLoop(){const t=3;this.context.clearRect(0,0,window.innerWidth,window.innerHeight);this.notes=this.notes.filter(e=>e.on||e.y<this.contextHeight-100);for(let e=0;e<this.notes.length;e++){const n=this.notes[e];if(n.on){n.height+=t}else{n.y+=t}this.context.globalAlpha=1-n.y/this.contextHeight;this.context.fillStyle=n.color;this.context.fillRect(n.x,n.y,n.width,n.height)}window.requestAnimationFrame(()=>this.drawLoop())}}class Piano{constructor(){this.config={whiteNoteWidth:20,blackNoteWidth:20,whiteNoteHeight:70,blackNoteHeight:2*70/3};this.svg=document.getElementById("svg");this.svgNS="http://www.w3.org/2000/svg"}resize(e){const t=window.innerWidth/e;this.config.whiteNoteWidth=OCTAVES>6?t:Math.floor(t);this.config.blackNoteWidth=this.config.whiteNoteWidth*2/3;this.svg.setAttribute("width",window.innerWidth);this.svg.setAttribute("height",this.config.whiteNoteHeight)}draw(){this.svg.innerHTML="";const t=this.config.blackNoteWidth/2;let n=0;let i=0;let o=0;const s=[1,3,6,8,10];if(OCTAVES>6){this.makeRect(0,n,i,this.config.whiteNoteWidth,this.config.whiteNoteHeight,"white","#141E30");this.makeRect(2,this.config.whiteNoteWidth,i,this.config.whiteNoteWidth,this.config.whiteNoteHeight,"white","#141E30");o=3;n=2*this.config.whiteNoteWidth}else{o=3+CONSTANTS.NOTES_PER_OCTAVE}for(let e=0;e<OCTAVES;e++){for(let e=0;e<CONSTANTS.NOTES_PER_OCTAVE;e++){if(s.indexOf(e)===-1){this.makeRect(o,n,i,this.config.whiteNoteWidth,this.config.whiteNoteHeight,"white","#141E30");n+=this.config.whiteNoteWidth}o++}}if(OCTAVES>6){this.makeRect(o,n,i,this.config.whiteNoteWidth,this.config.whiteNoteHeight,"white","#141E30");this.makeRect(1,this.config.whiteNoteWidth-t,i,this.config.blackNoteWidth,this.config.blackNoteHeight,"black");o=3;n=this.config.whiteNoteWidth}else{o=3+CONSTANTS.NOTES_PER_OCTAVE;n=-this.config.whiteNoteWidth}for(let e=0;e<OCTAVES;e++){for(let e=0;e<CONSTANTS.NOTES_PER_OCTAVE;e++){if(s.indexOf(e)!==-1){this.makeRect(o,n+this.config.whiteNoteWidth-t,i,this.config.blackNoteWidth,this.config.blackNoteHeight,"black")}else{n+=this.config.whiteNoteWidth}o++}}}highlightNote(e,t){const n=this.svg.querySelector(`rect[data-index="${e}"]`);if(!n){console.log("couldnt find a rect for note",e);return}n.setAttribute("active",true);n.setAttribute("class",`color-${t}`);return n}clearNote(e){e.removeAttribute("active");e.removeAttribute("class")}makeRect(e,t,n,i,o,s,a){const r=document.createElementNS(this.svgNS,"rect");r.setAttribute("data-index",e);r.setAttribute("x",t);r.setAttribute("y",n);r.setAttribute("width",i);r.setAttribute("height",o);r.setAttribute("fill",s);if(a){r.setAttribute("stroke",a);r.setAttribute("stroke-width","3px")}this.svg.appendChild(r);return r}}class MusicSequence{constructor(){this.notes=[];this._all=[];this.totalTime=0}addPitch(e,t,{lowestPianoKeyMidiNote:n=0,tag:i=""}){e+=n;const o=this.totalTime;const s=o+t;const a={pitch:e,startTime:o,endTime:s,tag:i};this.notes.push(a);this._all.push(a);this.totalTime=s}getLastNote=()=>{return this._getNotesWithoutTag(this.notes)[this.notes.length-1]};getSequence=(e=true)=>{const t=e?this.notes:this._all;return{notes:this._getNotesWithoutTag(t),totalTime:this.notes[t.length-1]?.endTime??0}};getSequencesByTag=(t,e=true)=>{const n=e?this.notes:this._all;if(!t){console.warn("tag is not provided while quering sequences by tag, returning all notes");return this._getNotesWithoutTag(n)}const i=this._getNotesWithoutTag(n.filter(e=>e.tag===t));return{notes:i,totalTime:i[i.length-1]?.endTime??0}};isEmpty=()=>{return this.notes.length===0};clear=()=>{this.notes=[];this.totalTime=0};_getNotesWithoutTag=e=>{return e.map(e=>{return{pitch:e.pitch,startTime:e.startTime,endTime:e.endTime}})}}class Timer{constructor(e){this.seconds=e||10;this.timerContainer=document.getElementById("info-container");this.currentTime=this.seconds;this.isRunning=false;this.interval=null}start=e=>{if(this.isRunning)return;this.isRunning=true;this.timerContainer.innerHTML="";this.toggleTimer();const t=document.createElement("p");t.className="info-text";t.textContent=this.seconds;this.timerContainer.appendChild(t);this.interval=setInterval(()=>{t.textContent=this.currentTime-1;if(this.currentTime===0){this.timerContainer.removeChild(t);this.reset();if(e&&typeof e==="function")e()}else{this.currentTime--}},1e3)};reset=()=>{this.clear();this.currentTime=this.seconds;this.isRunning=false;this.interval=null;this.toggleTimer()};toggleTimer=()=>{this.timerContainer.style.display=this.isRunning?"block":"none"};clear=()=>{if(!this.isRunning||!this.interval){console.warn("Cannot clear: Timer is not running or interval is undefined");return}clearInterval(this.interval)}}async function getSampleRnn(e,t={stepsPerQuarter:2,steps:50,temperature:1.3}){const n=mm.sequences.quantizeNoteSequence(e,t.stepsPerQuarter);const i=await musicRNN.continueSequence(n,t.steps,t.temperature);return mm.sequences.unquantizeSequence(i)}const MAPPING_8={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7};const MAPPING_4={0:0,1:2,2:5,3:7};const BUTTONS_DEVICE=["a","s","d","f","j","k","l",";"];const BUTTONS_MAKEY=["ArrowUp","ArrowLeft","ArrowDown","ArrowRight","w","a","s","d"];const USER_TURN="USER";const AI_TURN="AI";let currentPlayer=USER_TURN;let usedKeyboard=false;const BUTTONS_MAKEY_DISPLAY=["â†‘","â†","â†“","â†’","w","a","s","d"];let OCTAVES=7;let NUM_BUTTONS=8;let BUTTON_MAPPING=MAPPING_8;const modelConfig={stepsPerQuarter:2,steps:20,temperature:1.3,print:()=>{console.log(`stepsPerQuarter: ${modelConfig.stepsPerQuarter} | steps: ${modelConfig.steps} | temperature: ${modelConfig.temperature}`)}};let timerSeconds=10;let keyWhitelist;let TEMPERATURE=.25;const heldButtonToVisualData=new Map;let sustaining=false;let sustainingNotes=[];let mouseDownButton=null;const pianoPlayer=new Player;const sequence=new MusicSequence;const genie=new mm.PianoGenie(CONSTANTS.GENIE_CHECKPOINT);const musicRNN=new mm.MusicRNN("https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/melody_rnn");const painter=new FloatyNotes;const piano=new Piano;const timer=new Timer(timerSeconds);const infoContainer=document.getElementById("info-container");let isUsingMakey=false;const clickSaveButton=async e=>{settingsBox.hidden=true;console.log(modelConfig);if(e&&typeof e==="function"){await e()}};const openConfigBox=async(e=false)=>{const t=document.getElementById("configBoxButton");const n=document.getElementById("feedbackButton");if(e){n.style.display="block";t.style.display="none"}else{n.style.display="none";t.style.display="block"}settingsBox.hidden=false;disablePianoKeys()};initEverything();function initEverything(){genie.initialize().then(()=>{console.log("ðŸ§žâ€â™€ï¸ ready!");playBtn.textContent="Play";playBtn.removeAttribute("disabled");playBtn.classList.remove("loading")});musicRNN.initialize().then(()=>{console.log("ðŸ§žâ€â™€ï¸ Music RNN Ready!")});onWindowResize();updateButtonText();window.requestAnimationFrame(()=>painter.drawLoop());document.getElementById("spqButton1").addEventListener("change",e=>e.target.checked&&updateStepsPerQuarter(1));document.getElementById("spqButton2").addEventListener("change",e=>e.target.checked&&updateStepsPerQuarter(2));document.getElementById("spqButton4").addEventListener("change",e=>e.target.checked&&updateStepsPerQuarter(4));document.getElementById("stepsTextInput").addEventListener("change",e=>modelConfig.steps=parseInt(e.target.value));document.getElementById("temperatureTextInput").addEventListener("change",e=>modelConfig.temperature=parseFloat(e.target.value));document.getElementById("timerTextInput").addEventListener("change",e=>timerSeconds=parseInt(e.target.value));document.getElementById("configBoxButton").addEventListener("click",()=>clickSaveButton(enablePianoKeys));document.getElementById("feedbackButton").addEventListener("click",()=>clickSaveButton(aiTurn));window.addEventListener("resize",onWindowResize);window.addEventListener("orientationchange",onWindowResize)}const sleep=t=>new Promise(e=>setTimeout(e,t));function updateStepsPerQuarter(e){modelConfig.stepsPerQuarter=e}function showMainScreen(){document.querySelector(".splash").hidden=true;document.querySelector(".loaded").hidden=false;document.addEventListener("keydown",onKeyDown);controls.addEventListener("touchstart",e=>doTouchStart(e),{passive:true});controls.addEventListener("touchend",e=>doTouchEnd(e),{passive:true});const e="ontouchstart"in window;if(!e){controls.addEventListener("mousedown",e=>doTouchStart(e));controls.addEventListener("mouseup",e=>doTouchEnd(e))}controls.addEventListener("mouseover",e=>doTouchMove(e,true));controls.addEventListener("mouseout",e=>doTouchMove(e,false));controls.addEventListener("touchenter",e=>doTouchMove(e,true));controls.addEventListener("touchleave",e=>doTouchMove(e,false));canvas.addEventListener("mouseenter",()=>mouseDownButton=null);document.addEventListener("keyup",onKeyUp);const t=genie.nextFromKeyWhitelist(0,keyWhitelist,TEMPERATURE);genie.resetState();idleBoxContent(true)}function doTouchStart(e){e.preventDefault();mouseDownButton=e.target;buttonDown(e.target.dataset.id,true)}function doTouchEnd(e){e.preventDefault();if(mouseDownButton&&mouseDownButton!==e.target){buttonUp(mouseDownButton.dataset.id)}mouseDownButton=null;buttonUp(e.target.dataset.id)}function doTouchMove(e,t){if(!mouseDownButton)return;if(t)buttonDown(e.target.dataset.id,true);else buttonUp(e.target.dataset.id,true)}const currentPressedKey={pitch:null,startTime:null,endTime:null,addToSequence:e=>{if(!e){console.error("Cannot add pitch as Sequencer not provided")}if(!currentPressedKey.startTime){console.error("Cannot add pitch as start time not set")}if(!currentPressedKey.endTime){console.warn("endTime not provided for adding pitch to sequencer. Current time will be used as endTime");currentPressedKey.endTime=(new Date).getTime()}const t=(currentPressedKey.endTime-currentPressedKey.startTime)/1e3;e.addPitch(currentPressedKey.pitch,t,{tag:USER_TURN})}};const disablePianoKeys=()=>{const e=document.getElementsByClassName("btn-note");for(var t=0;t<e.length;t++){var n=e[t];n.classList.add("btn-disabled");n.setAttribute("disabled",true)}};const enablePianoKeys=()=>{const e=document.getElementsByClassName("btn-note");for(var t=0;t<e.length;t++){var n=e[t];n.classList.remove("btn-disabled");n.removeAttribute("disabled")}};const togglePianoKeys=()=>{if(currentPlayer===USER_TURN){enablePianoKeys();return}if(currentPlayer===AI_TURN){disablePianoKeys();return}console.error(`Current player is not recoginized: ${currentPlayer}`)};const switchPlayer=()=>{console.info(`Switching Player: old player = ${currentPlayer}`);currentPlayer=currentPlayer===USER_TURN?AI_TURN:USER_TURN;console.info(`Player Switched: current player = ${currentPlayer}`)};const updateInfoBox=()=>{infoContainer.style.display="block";const e=document.createElement("p");e.className="info-text";e.textContent="ðŸŽµ AI is playing... ðŸŽµ";infoContainer.appendChild(e);return e};const playAll=async()=>{const e=sequence.getSequence(false);for(const t of e.notes){const n=t.endTime-t.startTime;const i=t.pitch-CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE;try{const o=8;pianoPlayer.playNoteDown(t.pitch);const s=piano.highlightNote(i,o);if(!s){debugger}const a=painter.addNote(o,s.getAttribute("x"),s.getAttribute("width"));heldButtonToVisualData.set(0,{rect:s,note:i,noteToPaint:a});await sleep(n*1e3)}catch(e){console.warn(`note ${i} with pitch ${t.pitch} failed to play. Ignoring it`)}finally{buttonUp(0)}}};const firstTimeText=()=>`You can play your part on the piano, and the AI will join in. Ready to start? ðŸš€<br>
<span class='hint-playing'>Pro tip: Enhance your experience by using the keyboard for faster and more creative play. Try the number keys [1-8] or the home row [a-f],[j-;].
<span>`;const nonFirstTimeText=()=>{let e="Ready for another round? ðŸŽ¹ <br>It's your turn to play!";if(!usedKeyboard){e+=`<br/> <span class='hint-playing'>Remember to enhance your experience by using the keyboard for faster and more creative play. <br/>Experiment with the number keys [1-8] or the home row [a-f], [j-;].
    <span>`}return e};const idleBoxContent=e=>{infoContainer.innerHTML="";infoContainer.style.display="block";const t=document.createElement("p");t.className="info-text";t.innerHTML=e?firstTimeText():nonFirstTimeText();infoContainer.appendChild(t);if(!e){return;const n=document.createElement("button");n.textContent="Play the full melody ðŸŽ§";n.className="btn-green";n.disabled=true;n.onclick=async()=>{disablePianoKeys();t.textContent=`Enjoy the melody co-created by you and the AI! ðŸ¤©`;n.disabled=true;await playAll();enablePianoKeys();t.textContent=e?firstTimeText():nonFirstTimeText();n.disabled=false};infoContainer.appendChild(n)}};const addActionBox=async()=>{infoContainer.style.display="block";const e=document.createElement("p");e.className="info-text";e.innerHTML=`
  Did you enjoy it? ðŸ¤”<br/>
<span class='hint-playing'>If not, you can fine-tune your experience! Clicking 'No' opens a dialog where you can customize model configurations and generate another piece of melody.
</span>
  `;const t=document.createElement("button");t.textContent="Yes";t.className="btn-green";t.onclick=()=>{sequence.clear();switchPlayer();togglePianoKeys();idleBoxContent(false)};const n=document.createElement("button");n.textContent="No";n.className="btn-red";n.onclick=async()=>{infoContainer.innerHTML="";openConfigBox(true)};infoContainer.appendChild(e);infoContainer.appendChild(t);infoContainer.appendChild(n);return e};const showAlertBox=()=>{infoContainer.innerHTML="";infoContainer.style.display="block";const e=document.createElement("p");e.className="info-text";e.innerHTML=`ðŸ˜± Oops! It seems the AI didn't generate any music.<br>
  <span class='hint-playing'>You can inspire the AI by playing longer sequences or adjusting the model configurations.</span>`;const t=document.createElement("button");t.textContent="Change Configs";t.className="btn-green";t.onclick=async()=>{infoContainer.innerHTML="";openConfigBox(true)};const n=document.createElement("button");n.textContent="Play Again";n.className="btn-blue";n.onclick=async()=>{sequence.clear();switchPlayer();togglePianoKeys();idleBoxContent(false)};infoContainer.appendChild(e);infoContainer.appendChild(t);infoContainer.appendChild(n)};const aiTurn=async()=>{if(currentPlayer!==AI_TURN){switchPlayer();togglePianoKeys()}const e=updateInfoBox();const t=sequence.getSequencesByTag(USER_TURN);console.info(`sampling from model with input: ${t.notes.length} notes, duration ${t.totalTime}s`);modelConfig.print();const n=await getSampleRnn(t,modelConfig);if(!n||n.notes.length===0){showAlertBox();return}for(const i of n.notes){const o=i.endTime-i.startTime;const s=i.pitch-CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE;try{const a=8;pianoPlayer.playNoteDown(i.pitch);const r=piano.highlightNote(s,a);if(!r){debugger}const c=painter.addNote(a,r.getAttribute("x"),r.getAttribute("width"));heldButtonToVisualData.set(0,{rect:r,note:s,noteToPaint:c});await sleep(o*1e3)}catch(e){console.warn(`note ${s} with pitch ${i.pitch} failed to play. Ignoring it`)}finally{buttonUp(0)}sequence.addPitch(i.pitch,i.endTime-i.startTime,{tag:AI_TURN})}infoContainer.removeChild(e);addActionBox()};const buttonDown=async(e,t,n)=>{if(heldButtonToVisualData.has(e)){return}const i=document.getElementById(`btn${e}`);if(!i){console.warn(`Trying to press ${e} but the element not found`);return}if(i.getAttribute("disabled")==="true"){return}i.setAttribute("active",true);const o=genie.nextFromKeyWhitelist(BUTTON_MAPPING[e],keyWhitelist,TEMPERATURE);const s=CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE+o;currentPressedKey.pitch=s;currentPressedKey.startTime=(new Date).getTime();try{pianoPlayer.playNoteDown(s,e)}catch(e){console.warn(`note ${o} with pitch ${s} failed to play. Ignoring it`)}timer.start(async()=>{await aiTurn()});const a=piano.highlightNote(o,e);if(!a){debugger}const r=painter.addNote(e,a.getAttribute("x"),a.getAttribute("width"));heldButtonToVisualData.set(e,{rect:a,note:o,noteToPaint:r})};function buttonUp(e){const t=document.getElementById(`btn${e}`);if(!t)return;t.removeAttribute("active");const n=heldButtonToVisualData.get(e);if(n){piano.clearNote(n.rect);painter.stopNote(n.noteToPaint);const i=CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE+n.note;if(!sustaining){if(currentPlayer===USER_TURN){currentPressedKey.endTime=(new Date).getTime();currentPressedKey.addToSequence(sequence)}pianoPlayer.playNoteUp(i,e)}else{sustainingNotes.push(CONSTANTS.LOWEST_PIANO_KEY_MIDI_NOTE+n.note)}}heldButtonToVisualData.delete(e)}const onKeyDown=e=>{if(e.repeat){return}if(e.key===" "){sustaining=true}else if(e.key==="r"){console.log("ðŸ§žâ€â™€ï¸ resetting!");genie.resetState()}else{const t=getButtonFromKeyCode(e.key);if(t!=null){usedKeyboard=true;buttonDown(t,true)}}};function onKeyUp(e){if(e.key===" "){sustaining=false;sustainingNotes.forEach(e=>pianoPlayer.playNoteUp(e,-1));sustainingNotes=[]}else{const t=getButtonFromKeyCode(e.key);if(t!=null){usedKeyboard=true;buttonUp(t)}}}function onWindowResize(){OCTAVES=window.innerWidth>700?7:3;const e=OCTAVES>6?4:0;const t=CONSTANTS.NOTES_PER_OCTAVE*OCTAVES+e;const n=CONSTANTS.WHITE_NOTES_PER_OCTAVE*OCTAVES+(e-1);keyWhitelist=Array(t).fill().map((e,t)=>{if(OCTAVES>6)return t;return t+3+CONSTANTS.NOTES_PER_OCTAVE});piano.resize(n);painter.resize(piano.config.whiteNoteHeight);piano.draw()}function getButtonFromKeyCode(e){if(e>="1"&&e<=String(NUM_BUTTONS)){return parseInt(e)-1}const t=isUsingMakey?BUTTONS_MAKEY.indexOf(e):BUTTONS_DEVICE.indexOf(e);return t!==-1?t:null}function parseHashParameters(){const e=window.location.hash.substring(1);const n={};e.split("&").map(e=>{let t=e.split("=");n[t[0]]=t[1]});return n}function updateButtonText(){const t=document.querySelectorAll(".controls button.color");for(let e=0;e<t.length;e++){t[e].innerHTML=isUsingMakey?`<span>${BUTTONS_MAKEY_DISPLAY[e]}</span>`:`<span>${e+1}</span><br><span>${BUTTONS_DEVICE[e]}</span>`}}